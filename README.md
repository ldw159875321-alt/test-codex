# 乐天全自动订单分流与查重系统

“乐天全自动订单分流与查重系统”（Rakuten Order Sorter & De-duplicator）是一个基于 Python 的本地工具，用于自动完成订单查重、防乱码清洗、仓库分流以及混合订单预警。运行完成后会在输出目录生成 3 份 Excel：

1. **乐天仓发货单.xlsx**：需要走乐天仓 (RSL) 的订单。
2. **自发货单.xlsx**：上半部分是纯净的自发货订单；中间有 3 行红底警示线；下半部分是混合订单（同一客户跨仓下单）。
3. **更新后的历史总表.xlsx**：历史订单 + 今日新增订单，用于下一次运行。

## 环境准备

- Python 3.10+（本地可通过 `pyinstaller` 等方式打包为 `.exe`）。
- 依赖：`pandas`、`openpyxl`。

```bash
pip install pandas openpyxl
```

## 使用方式

在命令行执行：

```bash
python order_sorter.py <历史查重总表.xlsx> <今日RMS订单.csv> [今日BOSS订单.csv] --output <输出目录>
```

- **历史查重总表.xlsx**：过去所有已发货订单。
- **今日RMS订单.csv**：乐天后台导出的当日全量订单（支持 Shift-JIS 编码）。
- **今日BOSS订单.csv**（可选）：乐天仓出库单。未提供时所有新订单默认走自发货。
- `--output`：输出目录，默认当前路径。

## 处理逻辑

1. **防乱码与清洗**：自动尝试 Shift-JIS/UTF-8 解码；将全角数字字母转为半角，并清理电话/地址中的空格和横线。
2. **全局查重**：用当日 RMS 订单对比历史表，剔除历史已存在的订单号。
3. **智能分流**：
   - 未提供 BOSS 表时，全部新订单进入自发货列表。
   - 提供 BOSS 表时，订单号命中 BOSS 的归入「乐天仓 (RSL)」，其余归入「自发货」。
4. **混合订单预警**：按「姓名+地址+电话」匹配 RSL 与自发货订单，将同一客户跨仓下单的自发货订单单独下沉到表格下半部分。

运行成功后即可将生成的 Excel 交给仓库或发货团队，无需手动 VLOOKUP。
